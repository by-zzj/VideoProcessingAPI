# 视频处理API项目说明文档

## 项目概述

这是一个基于 ASP.NET Core 9.0 开发的视频处理API系统，主要功能是接收视频文件上传，使用FFmpeg进行HLS（HTTP Live Streaming）切片处理，并将处理后的文件存储到MinIO对象存储中，提供视频播放服务。

## 技术栈

- **框架**: ASP.NET Core 9.0
- **语言**: C# (.NET 9.0)
- **视频处理**: FFmpeg
- **对象存储**: MinIO
- **前端**: HTML5 + JavaScript + HLS.js
- **依赖注入**: Microsoft.Extensions.DependencyInjection
- **配置管理**: Microsoft.Extensions.Configuration

## 项目结构

```
VideoProcessingAPI/
├── Controllers/                 # API控制器
│   ├── UploadController.cs     # 视频上传控制器
│   └── PlayController.cs       # 视频播放控制器
├── Services/                   # 服务层
│   ├── Interfaces/            # 服务接口
│   │   ├── FileService.cs
│   │   ├── MinioService.cs
│   │   └── VideoProcessingService.cs
│   └── Implementations/       # 服务实现
│       ├── IFileService.cs
│       ├── IMinioService.cs
│       └── IVideoProcessingService.cs
├── Models/                     # 数据模型
│   ├── Config/                # 配置模型
│   │   ├── FfmpegConfig.cs
│   │   ├── MinioConfig.cs
│   │   └── UploadConfig.cs
│   ├── DTO/                   # 数据传输对象
│   │   ├── ProcessingResult.cs
│   │   └── UploadResponse.cs
│   └── Entities/              # 实体模型
│       └── VideoInfo.cs
├── Configuration/             # 配置扩展
│   └── ServiceExtensions.cs
├── Utilities/                 # 工具类
│   ├── FfmpegHelper.cs
│   └── FileValidator.cs
├── wwwroot/                   # 静态文件
│   └── upload.html           # 上传页面
├── Program.cs                # 程序入口
├── appsettings.json          # 配置文件
└── VideoProcessingAPI.csproj # 项目文件
```

## 核心功能

### 1. 视频上传与处理

**API端点**: `POST /api/upload/video`

**功能描述**:

- 接收视频文件上传（支持拖拽上传）
- 验证文件类型和大小
- 使用FFmpeg将视频转换为HLS格式
- 生成多个.ts切片文件和.m3u8播放列表
- 将原始视频和HLS文件上传到MinIO存储

**支持格式**:

- 输入: .mp4, .mov, .avi, .mkv, .webm
- 输出: HLS (.m3u8 + .ts文件)

**配置参数**:

- 最大文件大小: 1GB
- HLS切片时长: 10秒
- 临时存储路径: `VideoProcessingAPI/temp-uploads`

### 2. 视频播放服务

**API端点**:

- `GET /api/play/{date}/{videoName}/{fileName}` - 获取视频片段
- `GET /api/play/{date}/{videoName}/info` - 获取视频信息

**功能描述**:

- 提供HLS视频流的访问
- 支持按日期和视频名称组织文件结构
- 返回MinIO的公开访问URL
- 提供视频基本信息查询

### 3. 文件管理

**功能特性**:

- 自动创建临时目录处理文件
- 处理完成后自动清理临时文件
- 支持重试机制处理文件锁定问题
- 文件验证（类型、大小、格式）

## 配置说明

### appsettings.json 配置项

```json
{
  "Minio": {
    "Endpoint": "localhost:9000",           // MinIO服务地址
    "AccessKey": "user",                    // 访问密钥
    "SecretKey": "Zzj154810",               // 秘密密钥
    "UseSSL": false,                        // 是否使用SSL
    "Timeout": 30000,                       // 超时时间(毫秒)
    "RawBucket": "video-raw",               // 原始视频存储桶
    "HlsBucket": "video-hls"                // HLS文件存储桶
  },
  "Ffmpeg": {
    "Path": "D:/DevelopmentTool/ffmpeg-master-latest-win64-gpl-shared/bin/ffmpeg.exe", // FFmpeg可执行文件路径
    "HlsTime": 10,                          // HLS切片时长(秒)
    "HlsListSize": 0                        // HLS播放列表大小(0表示无限制)
  },
  "Upload": {
    "MaxFileSize": 1073741824,              // 最大文件大小(字节) 1GB
    "AllowedExtensions": [".mp4", ".mov", ".avi", ".mkv", ".webm"], // 允许的文件扩展名
    "TempPath": "VideoProcessingAPI/temp-uploads", // 临时文件路径
    "MaxRetryCount": 1,                     // 最大重试次数
    "RetryDelay": 1000                      // 重试延迟(毫秒)
  }
}
```

## 服务架构

### 1. MinioService (对象存储服务)

- **职责**: 管理MinIO对象存储操作
- **功能**:
  - 文件上传到MinIO
  - 存储桶管理
  - 生成公开访问URL
  - 检查对象是否存在

### 2. VideoProcessingService (视频处理服务)

- **职责**: 处理视频转换和HLS切片
- **功能**:
  - 调用FFmpeg进行视频处理
  - 生成HLS播放列表和切片文件
  - 获取视频元信息（时长、分辨率、编码格式）
  - 修改.m3u8文件中的URL引用

### 3. FileService (文件管理服务)

- **职责**: 管理本地文件操作
- **功能**:
  - 文件验证
  - 临时目录创建和管理
  - 文件保存和清理
  - 唯一文件名生成

## 前端界面

### upload.html 功能特性

1. **拖拽上传**: 支持拖拽文件到指定区域
2. **文件验证**: 客户端预验证文件类型和大小
3. **进度显示**: 实时显示上传进度和处理时间
4. **HLS播放**: 集成HLS.js播放器，支持自适应流媒体
5. **响应式设计**: 适配不同屏幕尺寸
6. **错误处理**: 完善的错误提示和异常处理

### 支持的浏览器

- Chrome (推荐)
- Firefox
- Safari (原生HLS支持)
- Edge

## 部署要求

### 系统要求

- Windows 10/11 或 Linux
- .NET 9.0 Runtime
- FFmpeg (需要配置到系统PATH或指定完整路径)

### 依赖服务

1. **MinIO服务器**

   - 版本: 建议使用2025.4.22及之前构建的版本（新版本管理界面功能被大幅削减）
   - 端口: 9000 (默认)
   - 需要创建两个存储桶: `video-raw` 和 `video-hls`
   - **重要提示**: MinIO在2025年4月22日之后的版本中大幅简化了管理界面，移除了许多实用功能，建议使用此日期之前的版本以获得完整的管理体验
2. **FFmpeg**

   - 版本: 最新稳定版
   - 需要支持HLS输出格式
   - 建议使用静态编译版本

### 部署步骤

1. **安装依赖**

   ```bash
   # 安装MinIO（推荐2025.4.22及之前版本）
   # 下载并安装FFmpeg
   # 安装.NET 6.0 Runtime
   ```
2. **配置服务**

   ```bash
   # 启动MinIO服务器（推荐使用2025.4.22及之前版本）
   minio server /data --console-address ":9001"

   # 创建存储桶
   # 配置访问密钥
   ```
3. **修改配置**

   ```bash
   # 编辑appsettings.json
   # 更新MinIO连接信息
   # 设置FFmpeg路径
   ```
4. **运行应用**

   ```bash
   dotnet run
   # 或
   dotnet VideoProcessingAPI.dll
   ```

## API使用示例

### 上传视频

```bash
curl -X POST "http://localhost:5135/api/upload/video" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@video.mp4"
```

### 播放视频

```bash
# 获取播放列表
curl "http://localhost:5135/api/play/2024-01-15/video-name/index.m3u8"

# 获取视频片段
curl "http://localhost:5135/api/play/2024-01-15/video-name/index0.ts"
```

## 性能优化

### 1. 文件处理优化

- 使用异步I/O操作
- 临时文件自动清理
- 支持大文件上传（最大1GB）

### 2. 存储优化

- 按日期组织文件结构
- 使用MinIO分布式存储
- 支持公开访问URL

### 3. 播放优化

- HLS自适应流媒体
- 支持多分辨率播放
- 浏览器缓存友好

## 安全考虑

### 1. 文件安全

- 文件类型白名单验证
- 文件大小限制
- 临时文件自动清理

### 2. 访问控制

- MinIO访问密钥管理
- 公开URL访问控制
- 请求超时设置

### 3. 错误处理

- 异常信息不暴露敏感数据
- 完善的日志记录
- 优雅的错误恢复

## 监控和日志

### 日志级别

- Information: 正常操作日志
- Warning: 警告信息
- Error: 错误信息

### 关键监控点

- 文件上传成功率
- 视频处理时间
- MinIO连接状态
- FFmpeg处理状态

## 扩展功能建议

### 1. 数据库集成

- 添加视频元数据存储
- 用户权限管理
- 播放统计

### 2. 多格式支持

- 支持更多输入格式
- 多分辨率输出
- 音频提取

### 3. 云存储支持

- AWS S3集成
- 阿里云OSS支持
- 腾讯云COS支持

### 4. 实时处理

- WebSocket进度推送
- 实时转码状态
- 队列管理

## 故障排除

### 常见问题

1. **FFmpeg未找到**

   - 检查FFmpeg路径配置
   - 确认FFmpeg可执行权限
2. **MinIO连接失败**

   - 检查MinIO服务状态
   - 验证访问密钥配置
   - 确认MinIO版本兼容性（建议使用2025.4.22及之前版本）
3. **文件上传失败**

   - 检查文件大小限制
   - 确认临时目录权限
4. **HLS播放失败**

   - 检查浏览器HLS支持
   - 验证.m3u8文件格式

### 调试模式

```bash
# 启用详细日志
export ASPNETCORE_ENVIRONMENT=Development
dotnet run
```

## 版本信息

- **项目版本**: 1.0.0
- **.NET版本**: 6.0
- **MinIO客户端**: 6.0.5
- **MinIO服务器**: 建议使用2025.4.22及之前版本
- **最后更新**: 2024年

## 许可证

本项目采用 MIT 许可证，详见 LICENSE 文件。

## 联系方式

如有问题或建议，请通过以下方式联系：

- 项目Issues: [GitHub Issues链接]
- 邮箱: [联系邮箱]

---

*本文档最后更新于 2024年*
